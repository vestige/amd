<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Amidakuji (Ruby.wasm)</title>
  <style>
    body {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      padding: 16px;
    }
    #screen {
      white-space: pre;
      border: 1px solid #ccc;
      padding: 12px;
      min-height: 20em;
    }
  </style>

  <!-- ruby.wasm -->
  <script src="https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.5.0/dist/browser.script.iife.js"></script>
</head>
<body>

<h1>あみだくじ（Ruby.wasm）</h1>

<div>
  <input id="cmd" placeholder="1..5 / R / END">
  <button id="run">実行</button>
</div>

<pre id="screen"></pre>

<script type="text/ruby">
  require "js"

  # ========= 表示バッファ =========
  $screen = ""

  def draw(text)
    $screen = text
  end

  def screen
    $screen
  end

  # ========= あみだロジック（超簡略版） =========
  COLS = 5
  ROWS = 8

  def new_amida
    @paths = Array.new(ROWS) { rand(COLS - 1) }
    @goal = rand(COLS)
  end

  def render(path_marks: nil)
    lines = []
    lines << "START"
    lines << " " + (1..COLS).map(&:to_s).join("   ")

    ROWS.times do |r|
      line = " "
      COLS.times do |c|
        line << (path_marks&.include?([r, c]) ? "*" : "|")
        line << "---" if c < COLS - 1 && @paths[r] == c
        line << "   " if c < COLS - 1 && @paths[r] != c
      end
      lines << line
    end

    lines << "GOAL"
    goals = Array.new(COLS, " ")
    goals[@goal] = "O"
    lines << " " + goals.join("   ")

    lines.join("\n")
  end

  def handle(cmd)
    cmd = cmd.strip.upcase
    return draw("End") if cmd == "END"

    if cmd == "R"
      new_amida
      return draw(render)
    end

    n = cmd.to_i
    unless (1..COLS).include?(n)
      return draw("input 1..#{COLS} / R / END\n\n" + render)
    end

    draw("Result: #{n}\n\n" + render)
  end

  # 初期化
  new_amida
  draw("input 1..#{COLS} / R / END\n\n" + render)
</script>

<script>
  const screen = document.getElementById("screen");
  const input  = document.getElementById("cmd");
  const btn    = document.getElementById("run");

  function redraw() {
    // ★ ここが「クリアしてから描く」の正体
    screen.textContent = RubyVM.eval("screen()");
  }

  btn.onclick = () => {
    RubyVM.eval(`handle(${JSON.stringify(input.value)})`);
    input.value = "";
    redraw();
  };

  redraw();
</script>

</body>
</html>
